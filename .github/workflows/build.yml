name: Build and Publish WPF App

on:
  workflow_dispatch:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  build:
    runs-on: windows-latest
    env:
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore desktopApp-feature_model/GeoLoom.sln

    - name: Build solution
      run: dotnet build desktopApp-feature_model/GeoLoom.sln

    - name: Publish app
      run: dotnet publish desktopApp-feature_model/GeoLoom.sln

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wpf-build
        path: publish/

    - name: Send email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.sendgrid.net
        server_port: 587
        username: apikey
        password: ${{ secrets.SENDGRID_API_KEY }}
        subject: "âœ… Build terminÃ© avec succÃ¨s"
        to: gael.pidoux@ynov.com
        from: ci@geoloom.dev
        body: |
          Le pipeline CI/CD GeoLoom WPF sâ€™est terminÃ© avec succÃ¨s. ðŸŽ‰
